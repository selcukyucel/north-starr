#!/usr/bin/env bash
set -euo pipefail

VERSION="2.3.0"
NORTH_STARR_HOME="${NORTH_STARR_HOME:-}"

# Resolve where templates live
resolve_template_dir() {
  if [[ -n "$NORTH_STARR_HOME" ]]; then
    echo "$NORTH_STARR_HOME/templates"
    return
  fi

  # Check common install locations
  local script_dir
  script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  local parent_dir="$(dirname "$script_dir")"

  if [[ -d "$parent_dir/templates" ]]; then
    echo "$parent_dir/templates"
    return
  fi

  # Homebrew cellar path
  if [[ -d "/usr/local/share/north-starr/templates" ]]; then
    echo "/usr/local/share/north-starr/templates"
    return
  fi

  # Apple Silicon Homebrew
  if [[ -d "/opt/homebrew/share/north-starr/templates" ]]; then
    echo "/opt/homebrew/share/north-starr/templates"
    return
  fi

  echo ""
}

# Resolve where skills live (root-level for plugin, or via templates symlink)
resolve_skills_dir() {
  local template_dir="$1"
  local parent_dir="$(dirname "$template_dir")"

  # Root-level skills/ (plugin structure)
  if [[ -d "$parent_dir/skills" ]]; then
    echo "$parent_dir/skills"
    return
  fi

  # Symlinked through templates/claude/skills
  if [[ -d "$template_dir/claude/skills" ]]; then
    echo "$template_dir/claude/skills"
    return
  fi

  echo ""
}

# Resolve and validate target directory
resolve_target_dir() {
  local dir="${1:-.}"
  if [[ ! -d "$dir" ]]; then
    print_error "Directory does not exist: $dir" >&2
    exit 1
  fi
  (cd "$dir" && pwd)
}

# Resolve template dir or exit with a clear error
require_template_dir() {
  local dir
  dir="$(resolve_template_dir)"
  if [[ -z "$dir" || ! -d "$dir" ]]; then
    print_error "Could not find north-starr templates." >&2
    print_info "Set NORTH_STARR_HOME to the north-starr install directory." >&2
    exit 1
  fi
  echo "$dir"
}

# Validate that copied skills have correct YAML frontmatter
validate_skills() {
  local skills_dir="$1"
  for skill_file in "$skills_dir"/*/SKILL.md; do
    [[ -f "$skill_file" ]] || continue
    if ! head -1 "$skill_file" | grep -q '^---$'; then
      print_warn "Missing YAML frontmatter: $(basename "$(dirname "$skill_file")")/SKILL.md"
    elif ! grep -q '^name:' "$skill_file"; then
      print_warn "Missing 'name' field: $(basename "$(dirname "$skill_file")")/SKILL.md"
    fi
  done
}

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

print_banner() {
  echo ""
  echo -e "${CYAN}    ★ ${BOLD}north-starr${NC}"
  echo -e "${DIM}    Your North Starr for Friction-Free Development${NC}"
  echo -e "${DIM}    Inspired by Idea Flow — Janelle Arty Starr${NC}"
  echo ""
}

print_success() {
  echo -e "${GREEN}  ✓${NC} $1"
}

print_info() {
  echo -e "${BLUE}  →${NC} $1"
}

print_warn() {
  echo -e "${YELLOW}  !${NC} $1"
}

print_error() {
  echo -e "${RED}  ✗${NC} $1"
}

# ─── INIT ──────────────────────────────────────────────────────────────────────

cmd_init() {
  local target_dir
  target_dir="$(resolve_target_dir "${1:-}")"

  print_banner

  local template_dir
  template_dir="$(require_template_dir)"

  local skills_dir
  skills_dir="$(resolve_skills_dir "$template_dir")"

  echo -e "${BOLD}  Initializing North Starr in:${NC}"
  echo -e "  ${DIM}$target_dir${NC}"
  echo ""

  # Check for existing files
  if [[ -d "$target_dir/.claude/skills" || -d "$target_dir/.github/skills" || -f "$target_dir/AGENTS.md" ]]; then
    print_warn "Some North Starr files already exist."
    echo ""
    read -rp "  Overwrite existing files? [y/N] " confirm
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
      echo ""
      print_info "Use ${BOLD}north-starr update${NC} to update skills without overwriting."
      exit 0
    fi
    echo ""
  fi

  # Copy AGENTS.md (universal — works with any AI tool)
  if [[ -f "$template_dir/AGENTS.md" ]]; then
    cp "$template_dir/AGENTS.md" "$target_dir/AGENTS.md"
    print_success "AGENTS.md — universal AI assistant instructions"
  fi

  # Copy skills to .claude/skills/ (Claude Code)
  if [[ -n "$skills_dir" && -d "$skills_dir" ]]; then
    mkdir -p "$target_dir/.claude/skills"
    cp -r "$skills_dir/"* "$target_dir/.claude/skills/"
    validate_skills "$target_dir/.claude/skills"
    print_success ".claude/skills/ — Claude Code skills"
  fi

  # Copy skills to .github/skills/ (VS Code Copilot)
  if [[ -n "$skills_dir" && -d "$skills_dir" ]]; then
    mkdir -p "$target_dir/.github/skills"
    cp -r "$skills_dir/"* "$target_dir/.github/skills/"
    validate_skills "$target_dir/.github/skills"
    print_success ".github/skills/ — VS Code Copilot skills"
  fi

  # Copy starter CLAUDE.md (Claude Code specific)
  if [[ -f "$template_dir/CLAUDE.md" ]]; then
    cp "$template_dir/CLAUDE.md" "$target_dir/CLAUDE.md"
    print_success "CLAUDE.md — Claude Code starter instructions"
  fi

  # Migrate from v1.x: clean up old .ai/ structure if user confirms
  if [[ -d "$target_dir/.ai" ]]; then
    echo ""
    print_warn "Found .ai/ directory from a previous version."
    print_info "North Starr v2 uses native AI tool primitives instead."
    print_info "Run ${CYAN}/bootstrap${NC} to regenerate project config."
    echo ""
    read -rp "  Remove old .ai/ directory? [y/N] " confirm_ai
    if [[ "$confirm_ai" == "y" || "$confirm_ai" == "Y" ]]; then
      rm -rf "$target_dir/.ai"
      print_success "Removed .ai/"
    else
      print_info "Kept .ai/ — you can remove it manually later."
    fi
  fi

  # Migrate from v1.x: remove old workflow reference doc
  if [[ -f "$target_dir/IDEAFLOW_AGENTIC_WORKFLOW.md" ]]; then
    rm "$target_dir/IDEAFLOW_AGENTIC_WORKFLOW.md"
    print_success "Removed IDEAFLOW_AGENTIC_WORKFLOW.md (no longer needed)"
  fi

  # Migrate from v1.x: remove old skills (deleted + renamed)
  for old_skill in ideaflow-sense ideaflow-model ideaflow-sculpt ideaflow-validate ideaflow-bootstrap ideaflow-invert ideaflow-document ideaflow-learn; do
    if [[ -d "$target_dir/.claude/skills/$old_skill" ]]; then
      rm -rf "$target_dir/.claude/skills/$old_skill"
      print_success "Removed .claude/skills/$old_skill (replaced in v2)"
    fi
  done

  echo ""
  echo -e "${GREEN}${BOLD}  Done!${NC} North Starr initialized."
  echo ""
  echo -e "  ${BOLD}What's next:${NC}"
  echo -e "  ${DIM}1.${NC} Open your AI coding tool (Claude Code, VS Code Copilot, Cursor, etc.)"
  echo -e "  ${DIM}2.${NC} Run ${CYAN}/architect${NC} (new project) or ${CYAN}/bootstrap${NC} (existing code)"
  echo -e "  ${DIM}3.${NC} Start working — your AI tool auto-loads the generated context"
  echo ""
  echo -e "  ${DIM}Available skills:${NC}"
  echo -e "    /architect  — Define architecture for a new project (before code exists)"
  echo -e "    /bootstrap  — Generate project config from existing code"
  echo -e "    /invert     — Deep risk analysis before complex tasks"
  echo -e "    /plan       — Break complex tasks into persistent implementation plans"
  echo -e "    /document   — Generate documentation for a module"
  echo -e "    /learn      — Update config from experience"
  echo ""
  echo -e "  ${DIM}Learn more: https://github.com/selcukyucel/north-starr${NC}"
  echo ""
}

# ─── UPDATE ────────────────────────────────────────────────────────────────────

cmd_update() {
  local target_dir
  target_dir="$(resolve_target_dir "${1:-}")"

  print_banner

  local template_dir
  template_dir="$(require_template_dir)"

  local skills_dir
  skills_dir="$(resolve_skills_dir "$template_dir")"

  echo -e "${BOLD}  Updating North Starr in:${NC}"
  echo -e "  ${DIM}$target_dir${NC}"
  echo ""

  # Update skills in .claude/skills/
  if [[ -n "$skills_dir" && -d "$skills_dir" ]]; then
    mkdir -p "$target_dir/.claude/skills"
    cp -r "$skills_dir/"* "$target_dir/.claude/skills/"
    validate_skills "$target_dir/.claude/skills"
    print_success "Updated .claude/skills/"
  fi

  # Update skills in .github/skills/
  if [[ -n "$skills_dir" && -d "$skills_dir" ]]; then
    mkdir -p "$target_dir/.github/skills"
    cp -r "$skills_dir/"* "$target_dir/.github/skills/"
    validate_skills "$target_dir/.github/skills"
    print_success "Updated .github/skills/"
  fi

  # Update AGENTS.md if it's still the starter template
  if [[ -f "$target_dir/AGENTS.md" ]] && grep -q "Run \`/bootstrap\` to generate" "$target_dir/AGENTS.md" 2>/dev/null; then
    cp "$template_dir/AGENTS.md" "$target_dir/AGENTS.md"
    print_success "Updated AGENTS.md (starter template)"
  elif [[ ! -f "$target_dir/AGENTS.md" ]]; then
    cp "$template_dir/AGENTS.md" "$target_dir/AGENTS.md"
    print_success "Created AGENTS.md (universal instructions)"
  else
    print_info "Skipped AGENTS.md (customized — not overwriting)"
  fi

  # Update starter CLAUDE.md only if not customized
  if [[ -f "$target_dir/CLAUDE.md" ]] && grep -q "Run \`/bootstrap\` to generate" "$target_dir/CLAUDE.md" 2>/dev/null; then
    cp "$template_dir/CLAUDE.md" "$target_dir/CLAUDE.md"
    print_success "Updated CLAUDE.md (starter template)"
  elif [[ ! -f "$target_dir/CLAUDE.md" ]]; then
    cp "$template_dir/CLAUDE.md" "$target_dir/CLAUDE.md"
    print_success "Created CLAUDE.md (starter template)"
  else
    print_info "Skipped CLAUDE.md (customized by bootstrap — not overwriting)"
  fi

  # Remove old skills from v1.x (deleted + renamed)
  for old_skill in ideaflow-sense ideaflow-model ideaflow-sculpt ideaflow-validate ideaflow-bootstrap ideaflow-invert ideaflow-document ideaflow-learn; do
    if [[ -d "$target_dir/.claude/skills/$old_skill" ]]; then
      rm -rf "$target_dir/.claude/skills/$old_skill"
      print_success "Removed .claude/skills/$old_skill (replaced in v2)"
    fi
  done

  echo ""
  echo -e "${GREEN}${BOLD}  Done!${NC} Skills updated to v${VERSION}."
  echo -e "  ${DIM}Your rules, agents, and project config were preserved.${NC}"
  echo ""
}

# ─── STATUS ────────────────────────────────────────────────────────────────────

cmd_status() {
  local target_dir
  target_dir="$(resolve_target_dir "${1:-}")"

  print_banner

  echo -e "${BOLD}  Project status:${NC} ${DIM}$target_dir${NC}"
  echo ""

  local initialized=true
  local bootstrapped=true

  # Check AGENTS.md (universal)
  if [[ -f "$target_dir/AGENTS.md" ]]; then
    if grep -q "Run \`/bootstrap\` to generate" "$target_dir/AGENTS.md" 2>/dev/null; then
      print_success "AGENTS.md — starter (run /bootstrap to generate project config)"
    else
      print_success "AGENTS.md — project-specific"
    fi
  else
    print_warn "AGENTS.md — missing"
    initialized=false
  fi

  # Check Claude Code skills
  if [[ -d "$target_dir/.claude/skills" ]]; then
    local claude_skill_count=$(find "$target_dir/.claude/skills" -name "SKILL.md" 2>/dev/null | wc -l | tr -d ' ')
    print_success ".claude/skills/ — ${claude_skill_count} skills (Claude Code)"
  else
    print_info ".claude/skills/ — not installed"
  fi

  # Check VS Code Copilot skills
  if [[ -d "$target_dir/.github/skills" ]]; then
    local github_skill_count=$(find "$target_dir/.github/skills" -name "SKILL.md" 2>/dev/null | wc -l | tr -d ' ')
    print_success ".github/skills/ — ${github_skill_count} skills (VS Code Copilot)"
  else
    print_info ".github/skills/ — not installed"
  fi

  # Check if at least one skill location exists
  if [[ ! -d "$target_dir/.claude/skills" && ! -d "$target_dir/.github/skills" ]]; then
    initialized=false
  fi

  # Check CLAUDE.md
  if [[ -f "$target_dir/CLAUDE.md" ]]; then
    if grep -q "Run \`/bootstrap\` to generate\|Run \`/architect\`" "$target_dir/CLAUDE.md" 2>/dev/null; then
      print_success "CLAUDE.md — starter"
      bootstrapped=false
    elif grep -q '\[DECLARED\]' "$target_dir/CLAUDE.md" 2>/dev/null; then
      local declared_count=$(grep -c '\[DECLARED\]' "$target_dir/CLAUDE.md" 2>/dev/null || echo 0)
      print_success "CLAUDE.md — architected (${declared_count} declared sections — run /bootstrap to validate)"
    else
      print_success "CLAUDE.md — project-specific"
    fi
  fi

  # Check Claude Code rules (created by bootstrap)
  if [[ -d "$target_dir/.claude/rules" ]]; then
    local rule_count=$(find "$target_dir/.claude/rules" -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
    print_success ".claude/rules/ — ${rule_count} rules"
  else
    bootstrapped=false
  fi

  # Check Claude Code agents (created by bootstrap)
  if [[ -d "$target_dir/.claude/agents" ]]; then
    local agent_count=$(find "$target_dir/.claude/agents" -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
    print_success ".claude/agents/ — ${agent_count} agents"
  else
    bootstrapped=false
  fi

  # Check VS Code Copilot instructions (created by bootstrap)
  if [[ -f "$target_dir/.github/copilot-instructions.md" ]]; then
    print_success ".github/copilot-instructions.md — Copilot instructions"
  fi

  # Check VS Code Copilot file-scoped instructions (created by bootstrap)
  if [[ -d "$target_dir/.github/instructions" ]]; then
    local instruction_count=$(find "$target_dir/.github/instructions" -name "*.instructions.md" 2>/dev/null | wc -l | tr -d ' ')
    if [[ "$instruction_count" -gt 0 ]]; then
      print_success ".github/instructions/ — ${instruction_count} scoped rules"
    fi
  fi

  # Check Cursor rules (created by bootstrap)
  if [[ -d "$target_dir/.cursor/rules" ]]; then
    local cursor_count=$(find "$target_dir/.cursor/rules" -name "*.mdc" -o -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
    if [[ "$cursor_count" -gt 0 ]]; then
      print_success ".cursor/rules/ — ${cursor_count} rules"
    fi
  fi

  # Check module-level CLAUDE.md files
  local module_claude_count=$(find "$target_dir" -name "CLAUDE.md" -not -path "$target_dir/CLAUDE.md" -not -path "$target_dir/.claude/*" -not -path "*/node_modules/*" -not -path "*/.git/*" 2>/dev/null | wc -l | tr -d ' ')
  if [[ "$module_claude_count" -gt 0 ]]; then
    print_success "Module CLAUDE.md — ${module_claude_count} files"
  fi

  # Warn about old v1.x artifacts
  if [[ -d "$target_dir/.ai" ]]; then
    echo ""
    print_warn ".ai/ directory found (v1.x artifact — can be removed)"
  fi
  if [[ -f "$target_dir/IDEAFLOW_AGENTIC_WORKFLOW.md" ]]; then
    print_warn "IDEAFLOW_AGENTIC_WORKFLOW.md found (v1.x artifact — can be removed)"
  fi

  echo ""

  if [[ "$initialized" == "false" ]]; then
    print_info "Run ${BOLD}north-starr init${NC} to install North Starr."
  elif [[ "$bootstrapped" == "false" ]]; then
    echo -e "  ${YELLOW}${BOLD}Skills installed.${NC} Run ${CYAN}/architect${NC} (new project) or ${CYAN}/bootstrap${NC} (existing code) to generate config."
  else
    echo -e "  ${GREEN}${BOLD}North Starr is fully configured.${NC}"
  fi
  echo ""
}

# ─── HELP ──────────────────────────────────────────────────────────────────────

cmd_help() {
  print_banner
  echo -e "${BOLD}  Usage:${NC} north-starr <command> [directory]"
  echo ""
  echo -e "${BOLD}  Commands:${NC}"
  echo -e "    ${CYAN}init${NC}     [dir]   Install North Starr skills in a project"
  echo -e "    ${CYAN}update${NC}   [dir]   Update skills (preserves your config)"
  echo -e "    ${CYAN}status${NC}   [dir]   Check setup status"
  echo -e "    ${CYAN}help${NC}             Show this help message"
  echo -e "    ${CYAN}version${NC}          Show version"
  echo ""
  echo -e "${BOLD}  Supported AI tools:${NC}"
  echo -e "    Claude Code, VS Code Copilot, Cursor, Windsurf"
  echo ""
  echo -e "${BOLD}  Examples:${NC}"
  echo -e "    ${DIM}north-starr init${NC}              # Initialize in current directory"
  echo -e "    ${DIM}north-starr init ~/my-project${NC}  # Initialize in specific directory"
  echo -e "    ${DIM}north-starr update${NC}             # Update to latest skills"
  echo -e "    ${DIM}north-starr status${NC}             # Check setup status"
  echo ""
  echo -e "${BOLD}  After init, use these skills in your AI tool:${NC}"
  echo -e "    /architect  — Define architecture for a new project (before code exists)"
  echo -e "    /bootstrap  — Generate project config from existing code"
  echo -e "    /invert     — Deep risk analysis before complex tasks"
  echo -e "    /plan       — Break complex tasks into persistent implementation plans"
  echo -e "    /document   — Generate documentation for a module"
  echo -e "    /learn      — Update config from experience"
  echo ""
  echo -e "  ${DIM}https://github.com/selcukyucel/north-starr${NC}"
  echo ""
}

# ─── MAIN ──────────────────────────────────────────────────────────────────────

main() {
  local command="${1:-help}"

  case "$command" in
    init)
      cmd_init "${2:-}"
      ;;
    update)
      cmd_update "${2:-}"
      ;;
    status)
      cmd_status "${2:-}"
      ;;
    help|--help|-h)
      cmd_help
      ;;
    version|--version|-v)
      echo "north-starr v${VERSION}"
      ;;
    *)
      print_error "Unknown command: $command"
      echo ""
      cmd_help
      exit 1
      ;;
  esac
}

main "$@"
