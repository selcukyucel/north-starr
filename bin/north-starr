#!/usr/bin/env bash
set -euo pipefail

VERSION="2.0.0"
NORTH_STARR_HOME="${NORTH_STARR_HOME:-}"

# Resolve where templates live
resolve_template_dir() {
  if [[ -n "$NORTH_STARR_HOME" ]]; then
    echo "$NORTH_STARR_HOME/templates"
    return
  fi

  # Check common install locations
  local script_dir
  script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  local parent_dir="$(dirname "$script_dir")"

  if [[ -d "$parent_dir/templates" ]]; then
    echo "$parent_dir/templates"
    return
  fi

  # Homebrew cellar path
  if [[ -d "/usr/local/share/north-starr/templates" ]]; then
    echo "/usr/local/share/north-starr/templates"
    return
  fi

  # Apple Silicon Homebrew
  if [[ -d "/opt/homebrew/share/north-starr/templates" ]]; then
    echo "/opt/homebrew/share/north-starr/templates"
    return
  fi

  echo ""
}

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

print_banner() {
  echo ""
  echo -e "${CYAN}    ★ ${BOLD}north-starr${NC}"
  echo -e "${DIM}    Your North Starr for Friction-Free Development${NC}"
  echo -e "${DIM}    Inspired by Idea Flow — Janelle Arty Starr${NC}"
  echo ""
}

print_success() {
  echo -e "${GREEN}  ✓${NC} $1"
}

print_info() {
  echo -e "${BLUE}  →${NC} $1"
}

print_warn() {
  echo -e "${YELLOW}  !${NC} $1"
}

print_error() {
  echo -e "${RED}  ✗${NC} $1"
}

# ─── INIT ──────────────────────────────────────────────────────────────────────

cmd_init() {
  local target_dir="${1:-.}"
  target_dir="$(cd "$target_dir" && pwd)"

  print_banner

  local template_dir
  template_dir="$(resolve_template_dir)"

  if [[ -z "$template_dir" || ! -d "$template_dir" ]]; then
    print_error "Could not find north-starr templates."
    echo "  Set NORTH_STARR_HOME to the north-starr install directory."
    exit 1
  fi

  echo -e "${BOLD}  Initializing North Starr in:${NC}"
  echo -e "  ${DIM}$target_dir${NC}"
  echo ""

  # Check for existing files
  if [[ -d "$target_dir/.claude/skills" || -f "$target_dir/CLAUDE.md" ]]; then
    print_warn "Some North Starr files already exist."
    echo ""
    read -rp "  Overwrite existing files? [y/N] " confirm
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
      echo ""
      print_info "Use ${BOLD}north-starr update${NC} to update skills without overwriting."
      exit 0
    fi
    echo ""
  fi

  # Copy .claude/skills/
  if [[ -d "$template_dir/claude/skills" ]]; then
    mkdir -p "$target_dir/.claude/skills"
    cp -r "$template_dir/claude/skills/"* "$target_dir/.claude/skills/"
    print_success ".claude/skills/ — workflow skills (bootstrap, invert, document, learn)"
  fi

  # Copy starter CLAUDE.md
  if [[ -f "$template_dir/CLAUDE.md" ]]; then
    cp "$template_dir/CLAUDE.md" "$target_dir/CLAUDE.md"
    print_success "CLAUDE.md — starter instructions for Claude Code"
  fi

  # Migrate from v1.x: clean up old .ai/ structure if user confirms
  if [[ -d "$target_dir/.ai" ]]; then
    echo ""
    print_warn "Found .ai/ directory from a previous version."
    print_info "North Starr v2 uses native Claude Code primitives instead."
    print_info "Run ${CYAN}/bootstrap${NC} to regenerate config as .claude/rules/ and .claude/agents/."
    echo ""
    read -rp "  Remove old .ai/ directory? [y/N] " confirm_ai
    if [[ "$confirm_ai" == "y" || "$confirm_ai" == "Y" ]]; then
      rm -rf "$target_dir/.ai"
      print_success "Removed .ai/"
    else
      print_info "Kept .ai/ — you can remove it manually later."
    fi
  fi

  # Migrate from v1.x: remove old workflow reference doc
  if [[ -f "$target_dir/IDEAFLOW_AGENTIC_WORKFLOW.md" ]]; then
    rm "$target_dir/IDEAFLOW_AGENTIC_WORKFLOW.md"
    print_success "Removed IDEAFLOW_AGENTIC_WORKFLOW.md (no longer needed)"
  fi

  # Migrate from v1.x: remove old skills (deleted + renamed)
  for old_skill in ideaflow-sense ideaflow-model ideaflow-sculpt ideaflow-validate ideaflow-bootstrap ideaflow-invert ideaflow-document ideaflow-learn; do
    if [[ -d "$target_dir/.claude/skills/$old_skill" ]]; then
      rm -rf "$target_dir/.claude/skills/$old_skill"
      print_success "Removed .claude/skills/$old_skill (replaced in v2)"
    fi
  done

  echo ""
  echo -e "${GREEN}${BOLD}  Done!${NC} North Starr initialized."
  echo ""
  echo -e "  ${BOLD}What's next:${NC}"
  echo -e "  ${DIM}1.${NC} Open Claude Code in this project"
  echo -e "  ${DIM}2.${NC} Run ${CYAN}/bootstrap${NC} to generate project-specific config"
  echo -e "  ${DIM}3.${NC} Start working — Claude Code auto-loads the generated context"
  echo ""
  echo -e "  ${DIM}Available skills:${NC}"
  echo -e "    /bootstrap  — Generate project config (rules, agents, CLAUDE.md)"
  echo -e "    /invert     — Deep risk analysis before complex tasks"
  echo -e "    /document   — Generate CLAUDE.md for a module"
  echo -e "    /learn      — Update config from experience"
  echo ""
  echo -e "  ${DIM}Learn more: https://github.com/selcukyucel/north-starr${NC}"
  echo ""
}

# ─── UPDATE ────────────────────────────────────────────────────────────────────

cmd_update() {
  local target_dir="${1:-.}"
  target_dir="$(cd "$target_dir" && pwd)"

  print_banner

  local template_dir
  template_dir="$(resolve_template_dir)"

  if [[ -z "$template_dir" || ! -d "$template_dir" ]]; then
    print_error "Could not find north-starr templates."
    echo "  Set NORTH_STARR_HOME to the north-starr install directory."
    exit 1
  fi

  echo -e "${BOLD}  Updating North Starr in:${NC}"
  echo -e "  ${DIM}$target_dir${NC}"
  echo ""

  # Update skills
  if [[ -d "$template_dir/claude/skills" ]]; then
    mkdir -p "$target_dir/.claude/skills"
    cp -r "$template_dir/claude/skills/"* "$target_dir/.claude/skills/"
    print_success "Updated .claude/skills/"
  fi

  # Update starter CLAUDE.md only if it hasn't been customized by bootstrap
  # Check if it still contains the "Getting Started" marker from the starter template
  if [[ -f "$target_dir/CLAUDE.md" ]] && grep -q "Run \`/bootstrap\` to generate" "$target_dir/CLAUDE.md" 2>/dev/null; then
    cp "$template_dir/CLAUDE.md" "$target_dir/CLAUDE.md"
    print_success "Updated CLAUDE.md (starter template)"
  elif [[ ! -f "$target_dir/CLAUDE.md" ]]; then
    cp "$template_dir/CLAUDE.md" "$target_dir/CLAUDE.md"
    print_success "Created CLAUDE.md (starter template)"
  else
    print_info "Skipped CLAUDE.md (customized by bootstrap — not overwriting)"
  fi

  # Remove old skills from v1.x (deleted + renamed)
  for old_skill in ideaflow-sense ideaflow-model ideaflow-sculpt ideaflow-validate ideaflow-bootstrap ideaflow-invert ideaflow-document ideaflow-learn; do
    if [[ -d "$target_dir/.claude/skills/$old_skill" ]]; then
      rm -rf "$target_dir/.claude/skills/$old_skill"
      print_success "Removed .claude/skills/$old_skill (replaced in v2)"
    fi
  done

  echo ""
  echo -e "${GREEN}${BOLD}  Done!${NC} Skills updated to v${VERSION}."
  echo -e "  ${DIM}Your rules, agents, and project CLAUDE.md were preserved.${NC}"
  echo ""
}

# ─── STATUS ────────────────────────────────────────────────────────────────────

cmd_status() {
  local target_dir="${1:-.}"
  target_dir="$(cd "$target_dir" && pwd)"

  print_banner

  echo -e "${BOLD}  Project status:${NC} ${DIM}$target_dir${NC}"
  echo ""

  local initialized=true
  local bootstrapped=true

  # Check skills
  if [[ -d "$target_dir/.claude/skills" ]]; then
    local skill_count=$(find "$target_dir/.claude/skills" -name "SKILL.md" 2>/dev/null | wc -l | tr -d ' ')
    print_success ".claude/skills/ — ${skill_count} skills installed"
  else
    print_warn ".claude/skills/ — missing"
    initialized=false
  fi

  # Check CLAUDE.md
  if [[ -f "$target_dir/CLAUDE.md" ]]; then
    if grep -q "Run \`/bootstrap\` to generate" "$target_dir/CLAUDE.md" 2>/dev/null; then
      print_success "CLAUDE.md — starter (run /bootstrap to generate project config)"
      bootstrapped=false
    else
      print_success "CLAUDE.md — project-specific"
    fi
  else
    print_warn "CLAUDE.md — missing"
    initialized=false
    bootstrapped=false
  fi

  # Check rules (created by bootstrap)
  if [[ -d "$target_dir/.claude/rules" ]]; then
    local rule_count=$(find "$target_dir/.claude/rules" -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
    print_success ".claude/rules/ — ${rule_count} rules"
  else
    print_info ".claude/rules/ — not yet created (run /bootstrap)"
    bootstrapped=false
  fi

  # Check agents (created by bootstrap)
  if [[ -d "$target_dir/.claude/agents" ]]; then
    local agent_count=$(find "$target_dir/.claude/agents" -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
    print_success ".claude/agents/ — ${agent_count} agents"
  else
    print_info ".claude/agents/ — not yet created (run /bootstrap)"
    bootstrapped=false
  fi

  # Check for module-level CLAUDE.md files (created by bootstrap or document)
  local module_claude_count=$(find "$target_dir" -name "CLAUDE.md" -not -path "$target_dir/CLAUDE.md" -not -path "$target_dir/.claude/*" -not -path "*/node_modules/*" -not -path "*/.git/*" 2>/dev/null | wc -l | tr -d ' ')
  if [[ "$module_claude_count" -gt 0 ]]; then
    print_success "Module CLAUDE.md — ${module_claude_count} files"
  fi

  # Warn about old v1.x artifacts
  if [[ -d "$target_dir/.ai" ]]; then
    echo ""
    print_warn ".ai/ directory found (v1.x artifact — can be removed)"
  fi
  if [[ -f "$target_dir/IDEAFLOW_AGENTIC_WORKFLOW.md" ]]; then
    print_warn "IDEAFLOW_AGENTIC_WORKFLOW.md found (v1.x artifact — can be removed)"
  fi

  echo ""

  if [[ "$initialized" == "false" ]]; then
    print_info "Run ${BOLD}north-starr init${NC} to install North Starr skills."
  elif [[ "$bootstrapped" == "false" ]]; then
    echo -e "  ${YELLOW}${BOLD}Skills installed.${NC} Run ${CYAN}/bootstrap${NC} in Claude Code to generate project config."
  else
    echo -e "  ${GREEN}${BOLD}North Starr is fully configured.${NC}"
  fi
  echo ""
}

# ─── HELP ──────────────────────────────────────────────────────────────────────

cmd_help() {
  print_banner
  echo -e "${BOLD}  Usage:${NC} north-starr <command> [directory]"
  echo ""
  echo -e "${BOLD}  Commands:${NC}"
  echo -e "    ${CYAN}init${NC}     [dir]   Install North Starr skills in a project"
  echo -e "    ${CYAN}update${NC}   [dir]   Update skills (preserves your config)"
  echo -e "    ${CYAN}status${NC}   [dir]   Check setup status"
  echo -e "    ${CYAN}help${NC}             Show this help message"
  echo -e "    ${CYAN}version${NC}          Show version"
  echo ""
  echo -e "${BOLD}  Examples:${NC}"
  echo -e "    ${DIM}north-starr init${NC}              # Initialize in current directory"
  echo -e "    ${DIM}north-starr init ~/my-project${NC}  # Initialize in specific directory"
  echo -e "    ${DIM}north-starr update${NC}             # Update to latest skills"
  echo -e "    ${DIM}north-starr status${NC}             # Check setup status"
  echo ""
  echo -e "${BOLD}  After init, use these Claude Code skills:${NC}"
  echo -e "    /bootstrap  — Generate project config (rules, agents, CLAUDE.md)"
  echo -e "    /invert     — Deep risk analysis before complex tasks"
  echo -e "    /document   — Generate CLAUDE.md for a module"
  echo -e "    /learn      — Update config from experience"
  echo ""
  echo -e "  ${DIM}https://github.com/selcukyucel/north-starr${NC}"
  echo ""
}

# ─── MAIN ──────────────────────────────────────────────────────────────────────

main() {
  local command="${1:-help}"

  case "$command" in
    init)
      cmd_init "${2:-}"
      ;;
    update)
      cmd_update "${2:-}"
      ;;
    status)
      cmd_status "${2:-}"
      ;;
    help|--help|-h)
      cmd_help
      ;;
    version|--version|-v)
      echo "north-starr v${VERSION}"
      ;;
    *)
      print_error "Unknown command: $command"
      echo ""
      cmd_help
      exit 1
      ;;
  esac
}

main "$@"
